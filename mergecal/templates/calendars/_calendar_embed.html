{% block calendar %}
  <div id="calendar"></div>
  <div class="modal fade"
       id="eventModal"
       tabindex="-1"
       aria-labelledby="eventModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="eventModalLabel"></h5>
          <button type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item" id="eventTimeItem">
              <i class="bi bi-clock me-2"></i>
              <span id="eventTime"></span>
            </li>
            <li class="list-group-item" id="eventLocationItem">
              <i class="bi bi-geo-alt me-2"></i>
              <span id="eventLocation"></span>
            </li>
            <li class="list-group-item" id="eventDescriptionItem">
              <i class="bi bi-info-circle me-2"></i>
              <span id="eventDescription"></span>
            </li>
            <li class="list-group-item" id="eventUrlItem">
              <i class="bi bi-link-45deg me-2"></i>
              <span id="eventUrl"></span>
            </li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button"
                  class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock calendar %}
{% block inline_javascript %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        themeSystem: 'bootstrap5',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listYear'
        },
        eventClassNames: 'bg-primary text-white',
        dayMaxEvents: true,
        initialView: 'dayGridMonth',
        eventSources: [{
          url: "{% url 'calendars:calendar_file' calendar.uuid %}",
          format: 'ics',
        }],
        eventClick: function(info) {
          var modal = new bootstrap.Modal(document.getElementById('eventModal'));
          var event = info.event;

          // Set modal title
          document.getElementById('eventModalLabel').textContent = event.title;

          // Set event time
          var timeStr = formatEventTime(event.start, event.end, event.allDay);
          document.getElementById('eventTime').textContent = timeStr;
          document.getElementById('eventTimeItem').style.display = 'list-item';

          // Set location if available
          var locationEl = document.getElementById('eventLocationItem');
          if (event.extendedProps.location) {
            document.getElementById('eventLocation').textContent = event.extendedProps.location;
            locationEl.style.display = 'list-item';
          } else {
            locationEl.style.display = 'none';
          }

          // Set description if available
          var descriptionEl = document.getElementById('eventDescriptionItem');
          if (event.extendedProps.description) {
            document.getElementById('eventDescription').textContent = event.extendedProps.description;
            descriptionEl.style.display = 'list-item';
          } else {
            descriptionEl.style.display = 'none';
          }

          // Set URL if available
          var urlEl = document.getElementById('eventUrlItem');
          if (event.url) {
            document.getElementById('eventUrl').innerHTML = '<a href="' + event.url + '" target="_blank">Event Link</a>';
            urlEl.style.display = 'list-item';
          } else {
            urlEl.style.display = 'none';
          }

          modal.show();
        },
        eventContent: function(arg) {
          return {
            html: `<div class="fc-event-title">${arg.event.title}</div>`
          };
        }
      });
      calendar.render();
    });

    function formatEventTime(start, end, allDay) {
      var options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        timeZoneName: 'short'
      };

      if (allDay) {
        options.hour = undefined;
        options.minute = undefined;
        options.timeZoneName = undefined;
        return start.toLocaleDateString(undefined, options);
      }

      var startStr = start.toLocaleString(undefined, options);
      if (!end) return startStr;

      var endStr = end.toLocaleString(undefined, {
        hour: 'numeric',
        minute: '2-digit',
        timeZoneName: 'short'
      });

      // If start and end are on the same day, only show the date once
      if (start.toDateString() === end.toDateString()) {
        endStr = end.toLocaleString(undefined, {
          hour: 'numeric',
          minute: '2-digit',
          timeZoneName: 'short'
        });
      } else {
        endStr = end.toLocaleString(undefined, options);
      }

      return `${startStr} - ${endStr}`;
    }
  </script>
{% endblock inline_javascript %}
